# USB ä¸²å£é©±åŠ¨åˆ†æ

æœ¬ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªç®€åŒ–çš„ **USB è½¬ä¸²å£é©±åŠ¨**ï¼Œæ¼”ç¤ºäº†æ‰¹é‡ä¼ è¾“å’Œ TTY å±‚æ¥å£ã€‚

## ğŸ“„ æºä»£ç 

- [usb_serial_example.c](usb_serial_example.c) - 467è¡Œç¤ºä¾‹ä»£ç 

## ğŸ“Š åˆ†æç»“æœ

| åˆ†æå™¨ | ç»“æœæ–‡ä»¶ | è¯´æ˜ |
|--------|----------|------|
| basic_analyzer | [basic_analysis.json](basic_analysis.json) | å‡½æ•°è°ƒç”¨æµ + å›è°ƒæ˜ å°„ |
| advanced_analyzer | [advanced_analysis.json](advanced_analysis.json) | ç»“æ„ä½“å…³ç³» + è°ƒç”¨å›¾ |

## ğŸ”¬ åˆ†ææ‘˜è¦

### å›è°ƒå‡½æ•°æ˜ å°„

#### USB é©±åŠ¨å›è°ƒ (usb_driver)

| å­—æ®µ | å‡½æ•° | è§¦å‘æ—¶æœº |
|------|------|----------|
| `.probe` | `usb_serial_probe()` | USBè®¾å¤‡æ’å…¥ä¸”VID/PIDåŒ¹é… |
| `.disconnect` | `usb_serial_disconnect()` | USBè®¾å¤‡ç§»é™¤ |

#### TTY æ“ä½œå›è°ƒ (tty_operations)

| å­—æ®µ | å‡½æ•° | è§¦å‘æ—¶æœº |
|------|------|----------|
| `.open` | `serial_open()` | ç”¨æˆ·æ‰“å¼€ /dev/ttyUSBx |
| `.close` | `serial_close()` | ç”¨æˆ·å…³é—­è®¾å¤‡ |
| `.write` | `serial_write()` | ç”¨æˆ·å†™å…¥æ•°æ® |
| `.write_room` | `serial_write_room()` | TTYå±‚æŸ¥è¯¢å¯å†™ç©ºé—´ |

### å¼‚æ­¥æœºåˆ¶

| ç±»å‹ | å‡½æ•° | ç”¨é€” |
|------|------|------|
| âš™ï¸ å·¥ä½œé˜Ÿåˆ— | `serial_send_work()` | å¼‚æ­¥å‘é€æ•°æ® |

### ç»“æ„ä½“å…³ç³»

```
usb_serial_private
    â”œâ”€â”€ usb_device *       (USBè®¾å¤‡)
    â”œâ”€â”€ usb_interface *    (USBæ¥å£)
    â”œâ”€â”€ tty_struct *       (TTYç»“æ„)
    â”œâ”€â”€ urb * (read/write) (USBè¯·æ±‚å—)
    â”œâ”€â”€ kfifo              (å†™ç¼“å†²åŒº)
    â”œâ”€â”€ work_struct        (å‘é€å·¥ä½œé˜Ÿåˆ—)
    â””â”€â”€ mutex              (äº’æ–¥é”)
```

### æ•°æ®æµ

```
ç”¨æˆ·ç©ºé—´                          å†…æ ¸ç©ºé—´                         USBè®¾å¤‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”€â”€â”€â”€â”€â”€â”€â”€â”€

write("/dev/ttyUSB0")
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ serial_write()
    â”‚                        â”‚
    â”‚                        â”œâ”€â”€ kfifo_in() ç¼“å­˜æ•°æ®
    â”‚                        â”‚
    â”‚                        â””â”€â”€ schedule_work()
    â”‚                               â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                    â–¼
    â”‚              serial_send_work()     â—€â”€â”€ å·¥ä½œé˜Ÿåˆ—çº¿ç¨‹
    â”‚                    â”‚
    â”‚                    â””â”€â”€ usb_submit_urb()
    â”‚                               â”‚
    â”‚                               â–¼
    â”‚                        [USBä¼ è¾“ä¸­...]
    â”‚                               â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                    â–¼
    â”‚              serial_write_bulk_callback()  â—€â”€â”€ URBå®Œæˆå›è°ƒ
    â”‚                    â”‚
    â”‚                    â””â”€â”€ schedule_work()  ç»§ç»­å‘é€
    â”‚
```

## ğŸ‘€ å¯è§†åŒ–æŸ¥çœ‹

1. æ‰“å¼€å¯è§†åŒ–å·¥å…·ï¼š

```bash
open ../../web/templates/call_flow_viewer.html
```

2. å¯¼å…¥ `basic_analysis.json` æŸ¥çœ‹è°ƒç”¨æµ
3. åˆ‡æ¢åˆ° `struct_viewer.html` å¯¼å…¥ `advanced_analysis.json` æŸ¥çœ‹ç»“æ„ä½“å…³ç³»

## ğŸ“ å­¦ä¹ è¦ç‚¹

1. **USB é©±åŠ¨æ¡†æ¶**
   - `usb_register()` æ³¨å†Œé©±åŠ¨
   - `probe/disconnect` å›è°ƒå¤„ç†è®¾å¤‡çƒ­æ’æ‹”

2. **TTY å­ç³»ç»Ÿ**
   - `alloc_tty_driver()` åˆ†é… TTY é©±åŠ¨
   - `tty_operations` å®šä¹‰ç»ˆç«¯æ“ä½œ

3. **URB (USB Request Block)**
   - `usb_alloc_urb()` åˆ†é… URB
   - `usb_fill_bulk_urb()` å¡«å……æ‰¹é‡ä¼ è¾“ URB
   - `usb_submit_urb()` æäº¤å¼‚æ­¥ä¼ è¾“

4. **ç¼“å†²åŒºç®¡ç†**
   - ä½¿ç”¨ `kfifo` ä½œä¸ºç¯å½¢ç¼“å†²åŒº
   - ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

5. **å¹¶å‘æ§åˆ¶**
   - `mutex` ä¿æŠ¤æ‰“å¼€/å…³é—­æ“ä½œ
   - `spinlock` ä¿æŠ¤å…±äº«æ•°æ®

